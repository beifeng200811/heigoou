/*Obfuscated by JShaman.com*/const path=require('path');const fs=require('fs');const request=require('request');const {ff_download:ff_download,isDownLoding:isDownLoding,all_ff_processes:all_ff_processes}=require('./../ffmpegUtil');const persistentDBPath=path['join'](__dirname,'./persistentDB.bfd');const Datastore=require('nedb-promises');const db=Datastore['create'](persistentDBPath);db['persistence']['setAutocompactionInterval']((0x568f6^0x56b1e)*(0x2ea7f^0x2ea43)*(0x34563^0x34566));exports['findAndDown']=async function find(_0x315fcb,_0x50fc2f,_0x4ce39b,_0x298a82,_0x56b567){const _0x533ba7=await db['find']({'_id':_0x315fcb})['exec']();var _0x1f1e1f={'message':'文件不存在，下载失败，请删除后重新抓取','success':0x0,'data':[],'message':'已加入下载列表'};if(_0x533ba7['length']<(0x96da3^0x96da2)){return _0x1f1e1f;}let _0xe1d6d9=_0x533ba7[0xc605b^0xc605b];let _0x52f797;if(_0xe1d6d9['type']=='sph'){let _0x294029=_0xe1d6d9['params'];_0x52f797='https://finder.video.qq.com/251/20302/stodownload?encfilekey='+_0x294029['encfilekey']+'&token='+_0x294029['token'];if(!_0x298a82){_0x298a82=new Date()['getTime']()+'.mp4';}else{if(_0x298a82['indexOf']('/')>-(0xcf86e^0xcf86f)){_0x298a82=_0x298a82['substring'](_0x298a82['lastIndexOf']('/')+(0x9252e^0x9252f));}else if(_0x298a82['indexOf']('\x5c')>-(0xbc292^0xbc293)){_0x298a82=_0x298a82['substring'](_0x298a82['lastIndexOf']('\x5c')+(0xe97df^0xe97de));}if(!_0x298a82['endsWith']('.mp4')){_0x298a82=new Date()['getTime']()+_0x298a82+'.mp4';}else{_0x298a82=new Date()['getTime']()+_0x298a82+'';}}}else if(_0xe1d6d9['type']=='sphLive'){_0x298a82='视频号直播-'+new Date()['getTime']()+'.mp4';}else if(_0xe1d6d9['type']=='douyin'){if(_0xe1d6d9['playAddr']['url_list']['length']==(0x2af1c^0x2af1f)){_0x52f797=_0xe1d6d9['playAddr']['url_list'][0x76508^0x7650a];}else{_0x52f797=_0xe1d6d9['url'];}_0x298a82=_0xe1d6d9['desc']['replace'](/\s/ig,'_')+'.mp4';}else if(_0xe1d6d9['type']=='global'){if(!_0x298a82){_0x298a82=new Date()['getTime']();}else{_0x298a82=new Date()['getTime']()+'_'+_0x298a82;}let _0x28cce3=_0xe1d6d9['ext'];;if(!_0x28cce3){if(contentType['startsWith']('audio')){_0x28cce3='mp3';}else if(contentType['startsWith']('video')){_0x28cce3='mp4';}}_0x298a82+='.'+_0x28cce3;if(_0x28cce3=='flv'||_0x28cce3=='m3u8'){console['log']('目前不支持下载，请手动执行');}else{_0x52f797=_0xe1d6d9['url'];}}const _0x4a0a47=path['join'](_0x4ce39b,_0x298a82);if(_0x52f797){console['log']('下载地址-->\x20'+_0x52f797);console['log']('存储路径-->\x20'+_0x4a0a47);_0x1f1e1f['success']=0xd6912^0xd6913;request(_0x52f797)['pipe'](fs['createWriteStream'](_0x4a0a47))['on']('close',()=>{console['log'](_0x4a0a47+'\x20下载完成');});}else{_0x1f1e1f['success']=0x1;if(isDownLoding(_0xe1d6d9['_id'])){console['log']('下载中\x20，不需要重复下载');}else{ff_download({'id':_0xe1d6d9['_id'],'filename':_0x4a0a47,'url':_0xe1d6d9['url']},function(_0x4d22a0){console['log'](''+_0x4d22a0);},function(_0x6c1b77,_0x28986e){console['log']('close\x20'+_0x28986e);},function(_0x249eb5,_0x4372b1){console['log']('error\x20'+_0x4372b1);},function(_0xc7972e,_0x186718){console['log']('exit\x20'+_0x186718);});_0xe1d6d9['ffDown']=0x1;}}_0xe1d6d9['downUrl']=_0x52f797;_0xe1d6d9['filename']=_0x4a0a47;_0x1f1e1f['data']['push'](_0xe1d6d9);_0xe1d6d9['downFlag']=0xf2faf^0xf2fae;await db['remove']({'_id':_0x315fcb},{'multi':!![]},function(_0x3071a1,_0x116fbb){});await db['insert'](_0xe1d6d9,function(_0x59b3c4,_0x3d301f){});return _0x1f1e1f;};exports['insert']=async function insert(_0x9710ad){if(!_0x9710ad){return;}const _0x34d2e5=new URL(_0x9710ad);const _0x2f0e43=new URLSearchParams(_0x34d2e5['search']);const _0x361b72=Object['fromEntries'](_0x2f0e43['entries']());const _0x563f53=_0x2f0e43['get']('encfilekey');var _0x2d349e={'_id':_0x563f53,'encfilekey':_0x563f53,'url':_0x9710ad,'time':new Date(),'params':_0x361b72,'type':'sph'};try{await db['remove']({'_id':_0x563f53});await db['insert'](_0x2d349e);}catch(_0x3c9a42){}};exports['findById']=async function findById(_0x1d3f2b){const _0x56f733=await db['findOne']({'_id':_0x1d3f2b})['exec']();return _0x56f733;};exports['insertDouYin']=async function insertDouYin(_0x42223f){try{await db['remove']({'_id':_0x42223f['_id']});await db['insert'](_0x42223f);}catch(_0xf095e2){}};exports['insertSphLive']=async function insert(_0x1a66ac){if(!_0x1a66ac){return;}const _0x284ac8=new URL(_0x1a66ac);const _0x1bb334=new URLSearchParams(_0x284ac8['search']);const _0x130e19=Object['fromEntries'](_0x1bb334['entries']());var _0x280752=_0x1a66ac['length'];if(_0x1a66ac['indexOf']('.flv')>-0x1){_0x280752=_0x1a66ac['indexOf']('.flv');}let _0x5de483=_0x1a66ac['substring'](_0x1a66ac['lastIndexOf']('/')+(0x95586^0x95587),_0x280752);if(!_0x5de483){_0x5de483=_0x1a66ac;}var _0x1aecff={'_id':_0x5de483,'encfilekey':_0x5de483,'url':_0x1a66ac,'time':new Date(),'params':_0x130e19,'type':'sphLive'};try{const _0x23d8d9=await db['findOne']({'_id':_0x5de483})['exec']()||_0x1aecff;await db['remove']({'_id':_0x5de483},{},function(_0x474fe9,_0x21660b){});await db['insert'](_0x23d8d9,function(_0x162a77,_0x38c159){});}catch(_0x17342b){}};exports['insertGlobalVideo']=async function insertGlobalVideo(_0x19e9d6,_0x163ce3,_0x2794c5,_0x38c5c3,_0x2bf405){if(!_0x19e9d6){return;}const _0x5e6688=new URL(_0x19e9d6);const _0x5ee11a=new URLSearchParams(_0x5e6688['search']);const _0x408088=Object['fromEntries'](_0x5ee11a['entries']());var _0x569799={'_id':_0x19e9d6,'encfilekey':_0x19e9d6,'url':_0x19e9d6,'time':new Date(),'params':_0x408088,'type':'global','name':_0x38c5c3,'size':_0x2794c5,'ext':_0x2bf405,'contentType':_0x163ce3};try{const _0x10c9a5=await db['findOne']({'_id':_0x19e9d6})['exec']()||_0x569799;await db['remove']({'_id':_0x19e9d6},{},function(_0xba324d,_0x545fbc){});await db['insert'](_0x10c9a5,function(_0x44cf11,_0x43f14a){});}catch(_0x47e3bc){}};exports['page']=async function page(_0x3a8c05,_0x1501c8,_0x580085){if(!_0x1501c8){_0x1501c8=0xa;}if(_0x3a8c05<(0x48610^0x48611)){_0x3a8c05=0x1;}const _0x108630=(_0x3a8c05-0x1)*0xa;var _0xa15c36={'pageNumber':_0x3a8c05,'pageTotal':0x1,'pageSize':_0x1501c8,'totalNumber':0x0,'data':[]};const _0x4ad42f=await db['count']({});_0xa15c36['totalNumber']=_0x4ad42f;if(_0x4ad42f>0x0){let _0x4abd36=Math['floor']((_0x4ad42f+_0x1501c8-0x1)/_0x1501c8);if(_0x4abd36<0x1){_0x4abd36=0xf121d^0xf121c;}_0xa15c36['pageTotal']=_0x4abd36;if(_0x3a8c05>_0x4abd36){_0xa15c36['pageNumber']=_0x4abd36;}const _0x417189=await db['find']({})['sort']({'time':0x1})['skip'](_0x108630)['limit'](_0x1501c8)['exec']();const _0x495208=all_ff_processes();for(var _0x55ecf2=0x0;_0x55ecf2<_0x417189['length'];_0x55ecf2++){var _0x24e86c=_0x417189[_0x55ecf2];if(_0x495208[_0x24e86c['_id']]){_0x24e86c['ffDown']=0x1;}else{_0x24e86c['ffDown']=0xd21b8^0xd21b8;}let _0x26cb06='';if(_0x24e86c['type']=='sph'){let _0x27c9e0=_0x24e86c['params'];if(_0x27c9e0['scene']){_0x26cb06=_0x24e86c['url'];}else{_0x26cb06='https://finder.video.qq.com/251/20302/stodownload?encfilekey='+_0x27c9e0['encfilekey']+'&token='+_0x27c9e0['token'];_0x26cb06+='&idx='+_0x27c9e0['idx']+'&adaptivelytrans='+_0x27c9e0['adaptivelytrans']+'&bizid='+_0x27c9e0['bizid']+'&dotrans='+_0x27c9e0['dotrans']+'&hy='+_0x27c9e0['hy']+'';let _0x461b82=_0x27c9e0['m'];const _0x5a392f=_0x27c9e0['taskid'];const _0x388598=_0x27c9e0['X-snsvideoflag'];if(!_0x461b82){_0x461b82='';}_0x26cb06+='&m='+_0x461b82+'&X-snsvideoflag=xV9';}}if(_0x24e86c['type']=='douyin'){if(_0x24e86c['playAddr']['url_list']['length']==0x3){_0x26cb06=_0x24e86c['playAddr']['url_list'][0x2];_0x24e86c['url']=_0x24e86c['playAddr']['url_list'][0xdff73^0xdff71];}else{_0x26cb06=_0x24e86c['url'];}}else{_0x26cb06=_0x24e86c['url'];}_0x24e86c['showUrl']=_0x26cb06;_0xa15c36['data']['push'](_0x24e86c);}}return _0xa15c36;};exports['remove']=function remove(_0xf7e3df){db['remove']({},{'multi':!![]},function(_0xc4bfed,_0x52d7b1){console['log'](_0x52d7b1,'\x20条数据已删除');});};